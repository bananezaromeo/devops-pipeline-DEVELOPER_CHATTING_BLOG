name: CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  ACR_NAME: ${{ secrets.ACR_NAME }}

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Extract metadata
        id: meta
        run: |
          echo "version=sha-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/devops-backend:${{ steps.meta.outputs.version }}
            ${{ secrets.ACR_LOGIN_SERVER }}/devops-backend:latest
          build-args: |
            BUILD_DATE=${{ steps.meta.outputs.date }}
            VCS_REF=${{ github.sha }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/devops-frontend:${{ steps.meta.outputs.version }}
            ${{ secrets.ACR_LOGIN_SERVER }}/devops-frontend:latest
          build-args: |
            BUILD_DATE=${{ steps.meta.outputs.date }}
            VCS_REF=${{ github.sha }}

      - name: Scan backend image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.ACR_LOGIN_SERVER }}/devops-backend:${{ steps.meta.outputs.version }}
          format: 'sarif'
          output: 'trivy-backend-results.sarif'

      - name: Scan frontend image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.ACR_LOGIN_SERVER }}/devops-frontend:${{ steps.meta.outputs.version }}
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-backend-results.sarif'
          category: 'trivy-backend'

      - name: Upload Trivy frontend results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-frontend-results.sarif'
          category: 'trivy-frontend'

  deploy:
    name: Deploy to Azure VM
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          pip install ansible
          pip install azure-cli-core azure-identity
          ansible-galaxy collection install azure.azcollection
          ansible-galaxy collection install community.docker

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VM_PUBLIC_IP }} >> ~/.ssh/known_hosts

      - name: Create Ansible inventory and extra vars
        run: |
          cat > ansible/inventory/hosts << EOF
          [app_servers]
          azure-vm ansible_host=${{ secrets.VM_PUBLIC_IP }} ansible_user=azureuser
          EOF
          
          cat > ansible/extra_vars.yml << 'EOF'
          ---
          acr_name: "${{ secrets.ACR_NAME }}"
          acr_login_server: "${{ secrets.ACR_LOGIN_SERVER }}"
          image_tag: "${{ needs.build-and-push.outputs.image_tag }}"
          db_user: "${{ secrets.DB_USER }}"
          db_password: "${{ secrets.DB_PASSWORD }}"
          db_name: "${{ secrets.DB_NAME }}"
          EOF
          
          echo "=== extra_vars.yml content ===" 
          cat ansible/extra_vars.yml

      - name: Run Ansible deployment
        working-directory: ./ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        run: |
          ansible-playbook playbooks/setup-server.yml -i inventory/hosts -e @extra_vars.yml -v

      - name: Verify deployment
        run: |
          sleep 30
          echo "Testing backend health on port 5000..."
          curl -v http://${{ secrets.VM_PUBLIC_IP }}:5000/health || echo "Backend health check failed"
          echo ""
          echo "Testing frontend on port 80..."
          curl -v http://${{ secrets.VM_PUBLIC_IP }}:80/ || echo "Frontend check failed"

      - name: Get VM IP
        id: get-ip
        run: echo "vm_ip=${{ secrets.VM_PUBLIC_IP }}" >> $GITHUB_OUTPUT

  post-deployment:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run smoke tests
        run: |
          echo "Running smoke tests against http://${{ secrets.VM_PUBLIC_IP }}"
          
          # Test frontend
          curl -f http://${{ secrets.VM_PUBLIC_IP }} || exit 1
          
          # Test backend health
          curl -f http://${{ secrets.VM_PUBLIC_IP }}:3000/health || exit 1
          
          # Test API endpoints
          curl -f http://${{ secrets.VM_PUBLIC_IP }}:3000/api || exit 1

      - name: Notify deployment success
        if: success()
        run: |
          echo "Deployment successful to http://${{ secrets.VM_PUBLIC_IP }}"
